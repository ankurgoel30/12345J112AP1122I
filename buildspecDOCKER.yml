version: 0.2

env:
  variables:
    JAVA_HOME: "/usr/lib/jvm/java-8-openjdk-amd64"
    TARGET: "DEV"
    VERSION: "0.7"

phases:
  install:
    commands:
      - echo Entered the install phase...
      - apt-get update -y
      - apt-get install -y software-properties-common
      - add-apt-repository ppa:openjdk-r/ppa
      - apt-get update -y
      - apt-get install -y openjdk-8-jdk
      - wget https://jcenter.bintray.com/org/apache/maven/apache-maven/3.3.9/apache-maven-3.3.9-bin.tar.gz
      - tar xzvf apache-maven-3.3.9-bin.tar.gz -C /opt/
      - export PATH=/opt/apache-maven-3.3.9/bin:$PATH
  pre_build:
    commands:
      - echo Entered the pre_build phase...
      - $(aws ecr get-login --region $AWS_DEFAULT_REGION)
  build:
    commands:
      - echo Entered the build phase...
      - echo Build started on `date`
      - docker build -t thr-japi --file Dockerfile.AWS --build-arg VER=$VERSION-$TARGET .
      - docker tag thr-japi:latest 743115313691.dkr.ecr.us-west-2.amazonaws.com/thr-japi:$TARGET
  post_build:
    commands:
      - echo Entered the post_build phase...
      - echo Build completed on `date`
      - echo Build pushing the docker image
      - docker push 743115313691.dkr.ecr.us-west-2.amazonaws.com/thr-japi:$TARGET
